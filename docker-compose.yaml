version: "2"

volumes:
  database:

services:
  application:
    build:
      context: ./docker
      dockerfile: ./dockerfile
      args:
        SYSTEM_USER_ID: ${SYSTEM_USER_ID}
        SYSTEM_USER_NAME: ${SYSTEM_USER_NAME}
    working_dir: /adserver
    volumes:
    - .:/adserver

  worker:
    extends:
      service: application
    command: ['php','artisan','queue:work']
    user: ${SYSTEM_USER_ID}

  cron:
    extends:
      service: application
    command: ['bash','-c','crontab /etc/cron.d/adserver-crontab && cron -f']
    volumes:
      - ./docker/cron/crontab:/etc/cron.d/adserver-crontab

  webserver:
    image: nginx:alpine
    working_dir: /adserver/public
    volumes:
    - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf
    - ./public:/adserver/public
    - ./storage/app:/adserver/storage/app

  database:
    image: percona
    environment:
    - MYSQL_ROOT_PASSWORD=adshares
    - MYSQL_DATABASE=adserver
    - MYSQL_USER=adserver
    - MYSQL_PASSWORD=adserver
    volumes:
      - database:/var/lib/mysql

  mailer:
    image: mailhog/mailhog:latest
    user: ${SYSTEM_USER_ID}

